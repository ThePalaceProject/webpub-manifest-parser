name: Publish Release

on:
  # The build will be triggered when we publish a release
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+

jobs:
  release:
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v2

    - name: Install Python ðŸ’»
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Setup Poetry ðŸ”§
      run: make init

    - name: Check if version matches ðŸª„
      run: |
        export GIT_TAG=$(git describe HEAD --tags --abbrev=0)
        export PROJECT_VERSION=v$(poetry version -s)
        echo $GIT_TAG
        echo $PROJECT_VERSION
        if [[ "$GIT_TAG" != "$PROJECT_VERSION" ]]; then exit 1; fi

    - name: Build & Publish ðŸ“š
      run: make publish
      env:
        POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_TOKEN }}